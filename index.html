<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãã‚Šä¸ŠãŒã‚Šã®ã‚ã‚‹ãŸã—ç®—ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã†</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f0f9ff;
            --panel-bg: #ffffff;
            --primary-color: #4da3ff;
            --accent-color: #ff9800;
            --text-color: #333333;
            --border-color: #cccccc;
            --block-yellow: #ffd600; 
            --success-color: #4caf50;
            --level-color: #ff5252;
            --counter-color: #9c27b0;
            --main-font: "UD Digi Kyokasho N-R", "UD Digi Kyokasho", "UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ N-R", "UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“", "BIZ UDPGothic", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            --coin-font: "Times New Roman", "YuMincho", "Hiragino Mincho ProN", "Yu Mincho", "MS PMincho", serif;
            
            --block-unit: 24px; 
        }

        body { 
            font-family: var(--main-font); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh;
            width: 100vw;
            touch-action: none; 
            overflow: hidden; 
            -webkit-touch-callout: none;
            user-select: none;
        }

        /* ãƒ­ãƒ¼ãƒ‰ä¸­ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 20000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }
        .loading-icon {
            font-size: 4rem;
            animation: bounce 1.5s infinite;
        }
        .loading-text {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: bold;
            margin-top: 15px;
        }

        .app-container { 
            width: 100%; 
            max-width: 1200px; 
            height: 98vh; 
            background-color: var(--panel-bg); 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            padding: 5px 12px; 
            box-sizing: border-box; 
            display: flex;
            flex-direction: column;
            position: relative;
        }

        header { text-align: center; margin-bottom: 2px; border-bottom: 1px dashed var(--border-color); padding-bottom: 2px; position: relative; }
        h1 { font-size: 2.2rem; color: var(--primary-color); margin: 2px 0 5px 0; font-weight: 700; text-shadow: 1px 1px 0 #fff; }

        .controls { display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; position: relative; padding-top: 5px; }
        
        .formula-row { display: flex; align-items: center; gap: 4px; font-size: 1.1rem; background: #f9f9f9; padding: 4px 12px; border-radius: 8px; border: 1px solid #eee; }
        .num-input { width: 54px; height: 36px; font-size: 1.5rem; text-align: center; border: 2px solid var(--border-color); border-radius: 6px; font-family: var(--main-font); }
        .header-answer { background-color: #f0f0f0; border-color: #aaa; color: var(--primary-color); font-weight: bold; }

        .btn { 
            color: white !important; border: none; padding: 8px 20px; font-size: 1rem; border-radius: 50px; cursor: pointer; font-weight: bold; 
            transition: transform 0.1s, box-shadow 0.1s; white-space: nowrap; font-family: var(--main-font); 
        }
        .btn:active { transform: translateY(1px); }

        #back-to-home-btn {
            background-color: #90a4ae; 
            font-size: 0.8rem; 
            padding: 4px 12px; 
            position: absolute; 
            left: 5px;
            top: 0px; 
            z-index: 1000;
        }

        .start-action-box {
            border: 4px solid gold;
            background-color: #fffde7;
            border-radius: 20px;
            padding: 10px;
            margin: 5px auto;
            width: fit-content;
            min-width: 250px;
            text-align: center;
        }

        #start-btn { 
            background-color: var(--primary-color); 
            box-shadow: 0 4px 0 #2a75c7; 
            font-size: 1.5rem; 
            padding: 12px 30px; 
            margin: 0 auto; 
            animation: pulse 2s infinite;
            display: block;
            width: 100%;
            border-radius: 50px;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        
        #next-btn { background-color: var(--success-color) !important; box-shadow: 0 3px 0 #388e3c; display: none; }
        #reset-progress-btn { background-color: #78909c; font-size: 0.8rem; padding: 2px 8px; border-radius: 8px; box-shadow: 0 2px 0 #546e7a; color: white; border: none; cursor: pointer; }

        .control-group { display: flex; align-items: center; gap: 8px; background: #fff; padding: 4px 10px; border-radius: 8px; border: 1px solid #f0f0f0; flex-wrap: wrap; justify-content: center; }

        .mode-radio-group { display: flex; gap: 15px; align-items: center; justify-content: flex-start; margin-top: 2px; }
        .mode-radio-label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: bold; font-size: 0.95rem; padding: 4px 8px; border-radius: 10px; transition: background 0.2s; }
        .mode-radio-label:hover { background: rgba(0,0,0,0.05); }
        .mode-radio-label input { cursor: pointer; width: 16px; height: 16px; margin: 0; }

        .auto-answer-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 1.3rem; 
            font-weight: 700;
            color: var(--counter-color);
        }
        .auto-answer-label input[type="checkbox"] {
            width: 28px;  
            height: 28px; 
            cursor: pointer;
            margin: 0;
        }

        .mini-icon { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; font-size: 10px; pointer-events: none; }
        .mini-coin { background: radial-gradient(circle at 30% 30%, #ffffff, #e0e0e0 40%, #bfbfbf 90%); border: 1px solid #a0a0a0; color: #555; font-family: serif; }
        .mini-block { background-color: var(--block-yellow); border: 1px solid #9c7c00; border-radius: 2px; width: 20px; height: 20px; }

        .instruction-area { 
            background-color: #fff9c4; border-radius: 12px; padding: 10px 15px; margin: 2px auto; width: 98%; 
            flex: 1; display: flex; flex-direction: column; justify-content: start; overflow-y: auto;
        }
        .instruction-section { 
            margin-bottom: 8px; padding: 8px 12px; background: rgba(255,255,255,0.7); border-radius: 10px; 
            text-align: left; 
        }
        .instruction-title { 
            font-size: 1.1rem; color: #f57f17; font-weight: bold; margin-bottom: 4px; 
            display: inline-block; border-bottom: 2px solid #f57f17; 
        }
        
        .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; max-width: 900px; margin: 0 auto; }
        .setup-item { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .icon-box { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: #fff; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 1.1rem; flex-shrink: 0; }

        .visual-guide-container { display: flex; justify-content: space-around; gap: 10px; margin-top: 5px; }
        .visual-guide-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; background: #fff; padding: 10px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .visual-guide-item svg { width: 100%; max-width: 140px; height: auto; }
        .visual-guide-text { font-size: 0.9rem; font-weight: bold; color: #333; line-height: 1.4; text-align: center; }
        
        .level-badge, .title-badge, .counter-badge { padding: 4px 12px; border-radius: 12px; font-weight: bold; font-size: 0.9rem; color: white; }
        .level-badge { background: var(--level-color); }
        .title-badge { background: var(--primary-color); }
        .counter-badge { background: var(--counter-color); }

        /* ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ */
        .workspace { display: none; flex-direction: row; gap: 15px; align-items: stretch; margin-top: 5px; flex: 1; overflow: hidden; min-height: 0; }
        
        .calc-panel { flex: 0 0 320px; background-color: #fafafa; border-radius: 15px; padding: 10px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .calc-wrapper { position: relative; margin-top: 40px; }
        
        .hissan-grid { 
            display: grid; grid-template-columns: repeat(3, 80px); grid-template-rows: 80px 80px 80px; 
            border: 2px solid #555; background: #fff; 
        }
        .hissan-cell { 
            border: 1px solid #ccc; 
            display: flex; align-items: center; justify-content: center; 
            font-family: var(--main-font); 
            font-size: 3.5rem; 
            position: relative; 
            padding-bottom: 4px; 
        }
        .hissan-cell:nth-child(4), .hissan-cell:nth-child(5), .hissan-cell:nth-child(6) { border-bottom: 3.5px solid #333; }

        .carry-box { 
            position: absolute; width: 34px; height: 34px; top: -38px; border: 2px dashed #ff9800; 
            background: #fff3e0; text-align: center; font-size: 1.2rem; line-height: 34px; 
            border-radius: 5px; color: #e65100; font-family: var(--main-font); z-index: 10; outline: none;
        }
        .carry-box.tens { left: 98px; } 
        .carry-box.hundreds { left: 18px; } 

        .operator { 
            font-size: 3.5rem; 
            position: absolute; 
            left: 4px; 
            top: 50%; 
            transform: translateY(-55%); 
            line-height: 1;
        }
        
        .hissan-input { 
            width: 100%; height: 100%; border: none; text-align: center; 
            font-size: 3.5rem; 
            color: var(--primary-color); 
            background: transparent; outline: none; 
            font-family: var(--main-font); 
        }

        /* è¦–è¦šãƒ‘ãƒãƒ«ï¼šè¡¨å…¨ä½“ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ä¿®æ­£ */
        .visual-panel { 
            flex: 1; 
            background-color: #fff; 
            border: 1px solid #eee; 
            border-radius: 15px; 
            padding: 5px; 
            overflow-y: auto; /* è¦ªãƒ‘ãƒãƒ«è‡ªä½“ã®ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
            overflow-x: hidden;
            min-height: 0; 
            box-sizing: border-box; 
            display: block; /* ä¸­èº«ã«åˆã‚ã›ã¦è‡ªç„¶ã«ä¼¸ã³ã‚‹ã‚ˆã†ã«å¤‰æ›´ */
            -webkit-overflow-scrolling: touch; /* ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã®ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        }

        /* ãƒ‘ãƒãƒ«å…¨ä½“ã¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .visual-panel::-webkit-scrollbar { width: 8px; }
        .visual-panel::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        .visual-panel::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        .visual-panel::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.4); }
        
        .coin-table { 
            display: grid; 
            /* æœ€å¾Œã®è¡Œ(ç­”ãˆã®æ )ãŒå†…å®¹ã«åˆã‚ã›ã¦ä¼¸ã³ã‚‹ã‚ˆã†ã«è¨­å®š */
            grid-template-rows: auto auto auto auto minmax(140px, auto); 
            gap: 1px; 
            background-color: #666; 
            border: 2px solid #666; 
            width: 100%; 
            max-width: 100%;
        }
        
        .coin-table.mode-coin { grid-template-columns: 1fr 1fr 1fr; }
        .coin-table.mode-block { grid-template-columns: 1fr 1fr 1fr; }

        .col-hundred { background-color: #fff0f5 !important; }
        .col-header-hundred { background-color: #ff8a80 !important; color: #fff; }
        .col-ten { background-color: #fffce0 !important; }
        .col-header-ten { background-color: #ffd600 !important; color: #555; }
        .col-one { background-color: #f0f8ff !important; }
        .col-header-one { background-color: #42a5f5 !important; color: #fff; }

        .col-header { text-align: center; font-weight: bold; padding: 5px; font-size: 0.9rem; }
        .coin-zone { min-height: 110px; padding: 5px; position: relative; z-index: 5; }
        
        .coin-zone.carry-row { min-height: 60px; padding-top: 22px; border-bottom: none; overflow: visible; z-index: 100; }
        .coin-zone.carry-row::after { content: "ãã‚Šã‚ãŒã‚Š"; position: absolute; top: 2px; left: 5px; font-size: 0.65rem; color: #555; opacity: 0.7; }
        
        /* ç­”ãˆã®æ ï¼šãƒœã‚¿ãƒ³ãŒéš ã‚Œãªã„ã‚ˆã†ã«æ‰‹å‰(z-index)ã«å‡ºã™ */
        .coin-zone.result-row { 
            border-top: 4px solid #666; 
            position: relative;
            z-index: 50; /* ã€ä¿®æ­£ã€‘å¢ƒç•Œæ¨ªç·šã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤ºã•ã›ã‚‹ */
        }

        .zone-label { position: absolute; bottom: 2px; left: 5px; font-size: 0.65rem; color: rgba(0,0,0,0.2); pointer-events: none; }

        .token { display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: grab; touch-action: none; user-select: none; transition: transform 0.1s; }
        .token.block { background-color: var(--block-yellow); border: 1.2px solid #9c7c00; box-sizing: border-box; }
        .token.block-1 { width: var(--block-unit); height: var(--block-unit); border-radius: 1px; }
        .token.block-5 { width: calc(var(--block-unit) * 5); height: var(--block-unit); border-radius: 2px; background-image: linear-gradient(to right, rgba(0,0,0,0.15) 1px, transparent 1px); background-size: var(--block-unit) 100%; }
        .token.block-10 { width: calc(var(--block-unit) * 10); height: var(--block-unit); border-radius: 2px; background-image: linear-gradient(to right, rgba(0,0,0,0.15) 1px, transparent 1px); background-size: var(--block-unit) 100%; }
        .token.block-100 { 
            width: calc(var(--block-unit) * 10); 
            height: calc(var(--block-unit) * 10); 
            border-radius: 3px; 
            background-image: linear-gradient(to right, rgba(0,0,0,0.15) 1px, transparent 1px), linear-gradient(to bottom, rgba(0,0,0,0.15) 1px, transparent 1px); 
            background-size: var(--block-unit) var(--block-unit); 
            z-index: 6; 
        }

        .coin-zone.carry-row .block-100 {
            position: absolute;
            top: -40px; 
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .token.coin { border-radius: 50%; box-sizing: border-box; font-family: var(--coin-font); text-shadow: 0px 1px 0px rgba(255,255,255,0.4); box-shadow: inset 0 0 3px rgba(0,0,0,0.3), 1px 2px 4px rgba(0,0,0,0.3); }
        .token.coin.coin-1 { width: 44px; height: 44px; border: 2px solid #a0a0a0; background: radial-gradient(circle at 30% 30%, #ffffff, #e0e0e0 40%, #bfbfbf 90%); color: #555; font-size: 1.2rem; }
        .token.coin.coin-10 { width: 48px; height: 48px; border: 2px solid #8b4513; background: radial-gradient(circle at 35% 35%, #e6a060, #b87333 50%, #8b4513 100%); color: #ffe4c4; box-shadow: inset 0 0 0 3px rgba(100, 50, 10, 0.4), 1px 2px 3px rgba(0,0,0,0.4); font-size: 1.3rem; }
        .token.coin.coin-100 { width: 52px; height: 52px; background: linear-gradient(135deg, #f5f5f5 0%, #dcdcdc 50%, #a9a9a9 100%); color: #333; border: 2px dashed #888; font-size: 1.4rem; }

        .token.ghost { opacity: 0.5 !important; pointer-events: none !important; }
        
        .token-container { display: flex !important; flex-direction: row; flex-wrap: wrap; gap: 2px !important; width: fit-content; justify-content: center; align-items: start; }
        .container-grid { display: grid !important; grid-template-columns: repeat(5, auto) !important; gap: 4px !important; }
        .container-coin-ten { display: grid !important; grid-template-columns: repeat(5, auto) !important; gap: 4px !important; }
        .container-ten { flex-direction: column !important; gap: 2px !important; }
        
        .coin-table.mode-block .col-one .container-grid { display: flex !important; flex-wrap: wrap !important; width: 100% !important; gap: 4px !important; align-items: center; justify-content: flex-start; }

        .ten-group-box { 
            display: grid !important; grid-template-columns: repeat(5, auto) !important; gap: 2px !important; 
            border: 2px dashed #ff5722; background-color: rgba(255, 87, 34, 0.08); 
            border-radius: 8px; padding: 4px; margin-right: 8px; position: relative; width: fit-content; 
            cursor: pointer; transition: transform 0.1s ease, background-color 0.1s;
        }
        .col-ten .ten-group-box { display: block !important; padding: 0; border: none; background: none; }

        .ten-group-box:hover { background-color: rgba(255, 87, 34, 0.15); }
        .ten-group-box:active { transform: scale(0.98); }

        /* ã€ä¿®æ­£ã€‘ãƒœã‚¿ãƒ³ã‚’å°‘ã—ä¸Šã«æŒã¡ä¸Šã’ã€å½±ã‚’ã¤ã‘ã¦æ‰‹å‰ã«ã‚ã‚‹ã“ã¨ã‚’å¼·èª¿ */
        .regroup-btn { 
            position: absolute; 
            top: -32px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 100; 
            background: #ff5722; 
            color: white; 
            border: none; 
            border-radius: 20px; 
            padding: 4px 10px; 
            font-size: 0.8rem; 
            cursor: pointer; 
            animation: bounce 1s infinite; 
            font-weight: bold; 
            white-space: nowrap; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .token-container.column-layout { flex-direction: column !important; align-items: center !important; }
        .fraction-container { display: grid; grid-template-columns: repeat(5, auto); gap: 4px; margin-top: 8px; }
        
        .coin-table.mode-block .col-one .fraction-container { display: flex !important; flex-direction: row !important; flex-wrap: wrap !important; gap: 4px !important; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
        @keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-3px); } }

        #feedback-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .big-correct-text { font-size: 5rem; font-weight: 900; color: #ff5722; text-shadow: 4px 4px 0 #fff; opacity: 0; transform: scale(0.5); transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .big-correct-text.show { opacity: 1; transform: scale(1.2); }
        
        .confetti-piece { position: fixed; width: 12px; height: 12px; top: -20px; z-index: 9998; border-radius: 3px; animation-name: fall; animation-timing-function: linear; animation-fill-mode: forwards; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .modal-content { background: white; padding: 25px; border-radius: 30px; text-align: center; border: 5px solid gold; max-width: 90%; }

        .footer-credit {
            text-align: center;
            font-size: 0.75rem;
            color: #888;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        /* ãƒ‡ãƒãƒƒã‚°ãƒ»IDç¢ºèªç”¨ */
        #user-id-footer {
            font-family: monospace;
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        /* ã‚¹ãƒãƒ›ã§ã®ãƒ–ãƒ­ãƒƒã‚¯ã®ã¯ã¿å‡ºã—ã‚’é˜²ããƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¨­å®š */
        @media (max-width: 600px) {
            :root {
                --block-unit: 14px; 
            }
            .token.coin.coin-1 { width: 30px; height: 30px; font-size: 1rem; }
            .token.coin.coin-10 { width: 34px; height: 34px; font-size: 1.1rem; }
            .token.coin.coin-100 { width: 38px; height: 38px; font-size: 1.2rem; }
            .hissan-cell { font-size: 2.5rem; }
            .hissan-input { font-size: 2.5rem; }
        }
    </style>
</head>
<body oncontextmenu="return false;">
    <!-- ã€ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•ã€‘ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¶ˆã—ã¦ç”»é¢ã‚’å‡ºã™ -->
    <script>
        setTimeout(function() {
            var el = document.getElementById('loading-overlay');
            if (el && el.style.display !== 'none') {
                el.style.opacity = '0';
                setTimeout(function(){ el.style.display = 'none'; }, 300);
            }
        }, 1500);
    </script>
    
    <!-- ãƒ­ãƒ¼ãƒ‰ä¸­ç”»é¢ -->
    <div id="loading-overlay">
        <div class="loading-icon">â³</div>
        <div class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ˆã¿ã“ã¿ã¡ã‚…ã†...</div>
    </div>

    <div id="feedback-overlay"><div id="big-text" class="big-correct-text">ã›ã„ã‹ã„ï¼</div></div>

    <div id="master-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div style="font-size:4rem;">ğŸ†</div>
            <h2 style="color:#ff9800; font-size: 2.2rem;">ã²ã£ç®—ãƒã‚¹ã‚¿ãƒ¼ï¼</h2>
            <p style="font-size: 1.2rem;">30ã‚‚ã‚“ ã›ã„ã‹ã„ ãŠã‚ã§ã¨ã†ï¼<br>ã‚ãªãŸã¯ ã‚‚ã† ã²ã£ã•ã‚“ã® ã¦ã‚“ã•ã„ã ã­ï¼</p>
            <button class="btn" id="modal-close-btn" style="background: gold; color: #333; margin-top: 20px; font-size: 1.1rem; padding: 10px 30px;">ã‚‚ã£ã¨ ã¤ã¥ã‘ã‚‹ï¼</button>
        </div>
    </div>

    <div class="app-container">
        <header>
            <button id="back-to-home-btn" class="btn" style="display:none;">â—€ ã‚‚ã©ã‚‹</button>
            <h1>ãã‚Šä¸ŠãŒã‚Šã®ã‚ã‚‹ãŸã—ç®—ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã†</h1>
            
            <div id="header-controls" class="controls" style="display:none;">
                 <div class="formula-row">
                    <span>ã—ãï¼š</span>
                    <input type="number" id="input1" class="num-input" readonly>
                    <span style="font-weight:bold; margin:0 2px;">ï¼‹</span>
                    <input type="number" id="input2" class="num-input" readonly>
                    <span style="font-weight:bold; margin:0 2px;">ï¼</span>
                    <input type="text" id="header-answer" class="num-input header-answer" readonly>
                </div>
                <button id="next-btn" class="btn">ã¤ãã® ã‚‚ã‚“ã ã„ â¡</button>
                <div class="control-group">
                    <div class="level-badge" id="level-display">ãƒ¬ãƒ™ãƒ«: 1</div>
                    <div class="title-badge" id="title-display">ã—ã‚‡ã†ã”ã†: ãŸã—ã–ã‚“ ã¿ãªã‚‰ã„</div>
                    <div class="counter-badge" id="counter-display">0ï¼30ã‚‚ã‚“</div>
                </div>
            </div>
        </header>

        <div id="instruction-area" class="instruction-area">
            <div class="instruction-section">
                <div class="instruction-title">1. ã˜ã‚…ã‚“ã³</div>
                <div class="setup-grid">
                    <div class="setup-item">
                        <div class="icon-box">ğŸ’°</div>
                        <div>
                            <strong>ãƒ¢ãƒ¼ãƒ‰ã‚’ ãˆã‚‰ã¼ã†</strong><br>
                            <div class="mode-radio-group">
                                <label class="mode-radio-label">
                                    <input type="radio" name="display-mode-radio" value="coin" checked>
                                    <span class="mini-icon mini-coin">1</span>
                                    <span>ãŠã‹ã­</span>
                                </label>
                                <label class="mode-radio-label">
                                    <input type="radio" name="display-mode-radio" value="block">
                                    <span class="mini-icon mini-block"></span>
                                    <span>ãƒ–ãƒ­ãƒƒã‚¯</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="setup-item">
                        <div class="icon-box">ğŸ¤–</div>
                        <div>
                            <strong><label class="auto-answer-label"><input type="checkbox" id="setting-auto-answer"> ã“ãŸãˆ ã˜ã©ã†</label></strong><br>
                            <span style="font-size:0.8rem; color:#666;">âœ…ã™ã‚‹ã¨ ã˜ã©ã†ã§ ã“ãŸãˆãŒ ã¯ã„ã‚‹ã‚ˆ</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="instruction-section">
                <div class="instruction-title">2. ã‚‚ãã²ã‚‡ã†</div>
                <div class="setup-grid">
                    <div class="setup-item">
                        <div class="icon-box" style="background:var(--level-color); color:white;">Lv</div>
                        <div>
                            <strong>ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</strong><br>
                            5ã‚‚ã‚“ ã›ã„ã‹ã„ã™ã‚‹ã”ã¨ã« ã—ã‚‡ã†ã”ã†ãŒ ã‹ã‚ã‚‹ã‚ˆï¼
                        </div>
                    </div>
                    <div class="setup-item">
                        <div class="icon-box" style="background:#78909c; color:white;">â†º</div>
                        <div>
                            <strong>ã¯ã˜ã‚ã‹ã‚‰</strong><br>
                            <button id="reset-progress-btn" class="btn" style="padding:2px 8px; font-size:0.8rem;">ãƒªã‚»ãƒƒãƒˆ</button>
                            <span style="font-size:0.8rem;">ã•ã„ã—ã‚‡ã« ã‚‚ã©ã‚Šã¾ã™</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="instruction-section">
                <div class="instruction-title">3. ã¤ã‹ã„ã‹ãŸ</div>
                <div class="visual-guide-container">
                    <div class="visual-guide-item">
                        <span class="visual-guide-text">â‘  ãŠã‹ã­ã‚’ ä¸‹ã®<br>ã‚ãã« ã†ã”ã‹ãã†ï¼</span>
                        <svg viewBox="0 0 100 100">
                            <defs><radialGradient id="grad-coin-1" cx="30%" cy="30%"><stop offset="0%" stop-color="#fff"/><stop offset="40%" stop-color="#e0e0e0"/><stop offset="90%" stop-color="#bfbfbf"/></radialGradient></defs>
                            <circle cx="50" cy="22" r="14" fill="url(#grad-coin-1)" stroke="#a0a0a0" stroke-width="1.5" />
                            <text x="50" y="27" text-anchor="middle" font-size="12" fill="#555" font-family="serif" font-weight="bold">1</text>
                            <line x1="50" y1="40" x2="50" y2="60" stroke="#555" stroke-width="3" stroke-linecap="round" />
                            <path d="M42 52 L50 60 L58 52" fill="none" stroke="#555" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                            <rect x="25" y="65" width="50" height="30" rx="5" fill="none" stroke="#999" stroke-width="2" />
                        </svg>
                    </div>
                    <div class="visual-guide-item">
                        <span class="visual-guide-text">â‘¡ 10ã“ ã‚ã¤ã¾ã£ãŸã‚‰<br>ãƒœã‚¿ãƒ³ã‚’ ãŠãã†ï¼</span>
                        <svg viewBox="0 0 140 100">
                            <rect x="5" y="32" width="130" height="60" rx="5" fill="rgba(255,87,34,0.05)" stroke="#ff5722" stroke-width="2" stroke-dasharray="4" />
                            <rect x="30" y="22" width="80" height="20" rx="10" fill="#ff5722" />
                            <text x="70" y="36" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">ãã‚Šã‚ã’ã‚‹ï¼</text>
                            <g transform="translate(10, 42)">
                                <circle cx="12" cy="12" r="10" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="12" y="16" text-anchor="middle" font-size="9" fill="#555" font-weight="bold">1</text>
                                <circle cx="36" cy="12" r="10" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="36" y="16" text-anchor="middle" font-size="9" fill="#555" font-weight="bold">1</text>
                                <circle cx="60" cy="12" r="10" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="60" y="16" text-anchor="middle" font-size="9" fill="#555" font-weight="bold">1</text>
                                <circle cx="84" cy="12" r="10" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="84" y="16" text-anchor="middle" font-size="9" fill="#555" font-weight="bold">1</text>
                                <circle cx="108" cy="12" r="10" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="108" y="16" text-anchor="middle" font-size="9" fill="#555" font-weight="bold">1</text>
                                <circle cx="12" cy="36" r="10" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="12" y="40" text-anchor="middle" font-size="9" fill="#555" font-weight="bold">1</text>
                                <circle cx="36" cy="36" r="10" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="36" y="40" text-anchor="middle" font-size="9" fill="#555" font-weight="bold">1</text>
                                <circle cx="60" cy="36" r="10" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="60" y="40" text-anchor="middle" font-size="9" fill="#555" font-weight="bold">1</text>
                                <circle cx="84" cy="36" r="10" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="84" y="40" text-anchor="middle" font-size="9" fill="#555" font-weight="bold">1</text>
                                <circle cx="108" cy="36" r="10" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="108" y="40" text-anchor="middle" font-size="9" fill="#555" font-weight="bold">1</text>
                            </g>
                        </svg>
                    </div>
                    <div class="visual-guide-item">
                        <span class="visual-guide-text">â‘¢ ã²ã£ç®—ã® ã‚ãã«<br>æ•°å­—ã‚’ ã‹ã“ã†ï¼</span>
                        <svg viewBox="0 0 120 100">
                            <rect x="15" y="20" width="90" height="70" fill="#fff" stroke="#555" stroke-width="2" />
                            <line x1="45" y1="20" x2="45" y2="90" stroke="#ddd" stroke-width="1" /><line x1="75" y1="20" x2="75" y2="90" stroke="#ddd" stroke-width="1" />
                            <line x1="15" y1="43" x2="105" y2="43" stroke="#ddd" stroke-width="1" /><line x1="15" y1="66" x2="105" y2="66" stroke="#333" stroke-width="2" />
                            <rect x="50" y="2" width="14" height="14" rx="2" fill="#fff3e0" stroke="#ff9800" stroke-dasharray="2" />
                            <text x="57" y="13" text-anchor="middle" font-size="11" fill="#e65100" font-weight="bold">1</text>
                            <text x="60" y="38" text-anchor="middle" font-size="16" fill="#333">1</text><text x="90" y="38" text-anchor="middle" font-size="16" fill="#333">8</text>
                            <text x="90" y="61" text-anchor="middle" font-size="16" fill="#333">7</text><text x="25" y="61" text-anchor="middle" font-size="16" fill="#333">ï¼‹</text>
                            <text x="60" y="84" text-anchor="middle" font-size="16" fill="#4da3ff" font-weight="bold">2</text><text x="90" y="84" text-anchor="middle" font-size="16" fill="#4da3ff" font-weight="bold">5</text>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="start-action-box">
                <button id="start-btn" class="btn">ã‘ã„ã•ã‚“ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            </div>
            
            <footer class="footer-credit">
                <span>&copy;2026ã€€ãã‚Šä¸ŠãŒã‚Šã®ã‚ã‚‹ãŸã—ç®—ãƒã‚¹ã‚¿ãƒ¼ã€€ï¼©ï¼£ï¼´æ”¯æ´ã®æœ</span>
                <!-- IDç¢ºèªç”¨ -->
                <span id="user-id-footer"></span>
            </footer>
        </div>

        <main class="workspace" id="main-workspace">
            <section class="calc-panel">
                <div class="calc-wrapper">
                    <input type="text" class="carry-box hundreds" id="carry-100" maxlength="1">
                    <input type="text" class="carry-box tens" id="carry-10" maxlength="1">
                    <div id="hissan-grid" class="hissan-grid"></div>
                </div>
                <button id="check-btn" class="btn" style="background-color: var(--accent-color); margin-top: 20px; width: 130px; border-radius: 8px; box-shadow: 0 4px 0 #e65100;">ç­”ãˆåˆã‚ã›</button>
                <div id="message-area" style="margin-top:10px;"></div>
            </section>
            <section class="visual-panel">
                <div class="coin-table mode-coin" id="coin-table">
                    <div class="col-header col-header-hundred">ã²ã‚ƒãã® ãã‚‰ã„</div>
                    <div class="col-header col-header-ten">ã˜ã‚…ã†ã® ãã‚‰ã„</div>
                    <div class="col-header col-header-one">ã„ã¡ã® ãã‚‰ã„</div>
                    <div class="coin-zone carry-row col-hundred" id="zone-carry-100" data-row="carry" data-val="100"></div>
                    <div class="coin-zone carry-row col-ten" id="zone-carry-10" data-row="carry" data-val="10"></div>
                    <div class="coin-zone carry-row col-one" id="zone-carry-1" data-row="carry" data-val="1"></div>
                    <div class="coin-zone col-hundred" id="zone-top-100" data-row="top" data-val="100"><span class="zone-label">ãŸã•ã‚Œã‚‹ã‹ãš</span></div>
                    <div class="coin-zone col-ten" id="zone-top-10" data-row="top" data-val="10"><span class="zone-label">ãŸã•ã‚Œã‚‹ã‹ãš</span></div>
                    <div class="coin-zone col-one" id="zone-top-1" data-row="top" data-val="1"><span class="zone-label">ãŸã•ã‚Œã‚‹ã‹ãš</span></div>
                    <div class="coin-zone col-hundred" id="zone-mid-100" data-row="mid" data-val="100"><span class="zone-label">ãŸã™ã‹ãš</span></div>
                    <div class="coin-zone col-ten" id="zone-mid-10" data-row="mid" data-val="10"><span class="zone-label">ãŸã™ã‹ãš</span></div>
                    <div class="coin-zone col-one" id="zone-mid-1" data-row="mid" data-val="1"><span class="zone-label">ãŸã™ã‹ãš</span></div>
                    <div class="coin-zone result-row col-hundred" id="zone-bot-100" data-row="bot" data-val="100"><span class="zone-label">ã“ãŸãˆ</span></div>
                    <div class="coin-zone result-row col-ten" id="zone-bot-10" data-row="bot" data-val="10"><span class="zone-label">ã“ãŸãˆ</span></div>
                    <div class="coin-zone result-row col-one" id="zone-bot-1" data-row="bot" data-val="1"><span class="zone-label">ã“ãŸãˆ</span></div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        const els = {
            workspace: document.getElementById('main-workspace'),
            instruction: document.getElementById('instruction-area'),
            hissanGrid: document.getElementById('hissan-grid'),
            coinTable: document.getElementById('coin-table'),
            checkBtn: document.getElementById('check-btn'),
            msg: document.getElementById('message-area'),
            startBtn: document.getElementById('start-btn'),
            nextBtn: document.getElementById('next-btn'),
            carry10: document.getElementById('carry-10'),
            carry100: document.getElementById('carry-100'),
            input1: document.getElementById('input1'),
            input2: document.getElementById('input2'),
            headerAns: document.getElementById('header-answer'),
            settingAnswer: document.getElementById('setting-auto-answer'),
            bigText: document.getElementById('big-text'),
            levelDisplay: document.getElementById('level-display'),
            titleDisplay: document.getElementById('title-display'),
            counterDisplay: document.getElementById('counter-display'),
            masterModal: document.getElementById('master-modal'),
            modalClose: document.getElementById('modal-close-btn'),
            resetBtn: document.getElementById('reset-progress-btn'),
            headerControls: document.getElementById('header-controls'),
            backToHomeBtn: document.getElementById('back-to-home-btn'),
            modeRadios: document.getElementsByName('display-mode-radio'),
            loadingOverlay: document.getElementById('loading-overlay'),
            userIdFooter: document.getElementById('user-id-footer')
        };

        const apiKey = "";
        let currentAudio = null;
        
        // çŠ¶æ…‹ç®¡ç†
        const state = {
            num1: 0, num2: 0, ans: 0, mode: 'coin', autoAnswer: false, questionCount: 0,
            isAnsweredCorrectly: false, audioContextStarted: false, audioCache: {},
            lastPraiseIndex: -1,
            lastGuideTime: 0,
            titles: ["ãŸã—ã–ã‚“ ã¿ãªã‚‰ã„", "ãŸã—ã–ã‚“ ã—ã‚…ãã‚‡ã†ã¡ã‚…ã†", "ãŸã—ã–ã‚“ ã‚ã„ã˜ã‚“", "ãŸã—ã–ã‚“ ãŸã¤ã˜ã‚“", "ãŸã—ã–ã‚“ ãŠã†", "ã²ã£ã•ã‚“ã® ã‹ã¿ã•ã¾"],
            counts: {}, layoutMap: {}, dragging: null,
            carry10Triggered: false,
            carry100Triggered: false,
            isPlaying: false 
        };

        const praises = [
            "ã›ã„ã‹ãƒ¼ãƒ¼ãƒ¼ã„ï¼ãã®ã¡ã‚‡ã†ã—ã ã‚ˆãƒ¼ï¼", 
            "ã™ã”ãƒ¼ãƒ¼ãƒ¼ã„ï¼ã¦ã‚“ã•ãƒ¼ã„ã ã­ï¼", 
            "ã ã„ã›ã„ã‹ãƒ¼ãƒ¼ãƒ¼ã„ï¼ãƒãƒƒãƒãƒªã ã‚ˆãƒ¼ï¼", 
            "ã‚„ã£ãŸã­ãƒ¼ãƒ¼ãƒ¼ï¼ã‹ã£ã“ã„ãƒ¼ãƒ¼ãƒ¼ï¼", 
            "ã™ã”ã™ãã‚‹ã‚ˆãƒ¼ï¼ã‹ã‚“ãºãã ã­ï¼",
            "ãŠã£ï¼ã ã„ã›ã„ã‹ãƒ¼ã„ï¼ã™ã”ã„ã™ã”ãƒ¼ã„ï¼",
            "ãã®ã¡ã‚‡ã†ã—ãƒ¼ï¼ã©ã‚“ã©ã‚“ã„ã“ãƒ¼ï¼",
            "ãƒ”ãƒ³ãƒãƒ¼ãƒ³ï¼ã ã„ã›ã„ã‹ãƒ¼ã„ï¼",
            "ãŠã‚ã§ã¨ãƒ¼ãƒ¼ãƒ¼ï¼30ã‚‚ã‚“ ãŸã£ã›ã„ã ã­ï¼ãã¿ã¯ ã‚‚ã† ã‚Šã£ã±ãª ã²ã£ç®—ãƒã‚¹ã‚¿ãƒ¼ã ã‚ˆï¼ã•ã„ã“ã†ã ã‚ˆï¼", 
            "ã‚ã‚Œã‚Œãƒ¼ï¼Ÿã‚‚ã†ã„ã¡ã© ã‹ã‚“ãŒãˆã¦ã¿ã¦ã­", 
            "ã¤ãã® ã‚‚ã‚“ã ã„ã‚’ ãŠã—ã¦ã­"
        ];

        function updateLevelUI() {
            const levelNum = Math.floor(state.questionCount / 5) + 1;
            if (els.levelDisplay) els.levelDisplay.textContent = `ãƒ¬ãƒ™ãƒ«: ${levelNum}`;
            if (els.titleDisplay) els.titleDisplay.textContent = `ã—ã‚‡ã†ã”ã†: ${state.titles[Math.min(Math.floor(state.questionCount / 5), state.titles.length - 1)]}`;
            if (els.counterDisplay) els.counterDisplay.textContent = `${state.questionCount}ï¼30ã‚‚ã‚“`;
        }

        // --- ã‚¨ãƒ©ãƒ¼ã§ä¿å­˜ãŒå¼¾ã‹ã‚Œãªã„ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼ˆJSONæ–‡å­—åˆ—ï¼‰ ---
        function getCleanStateData() {
            return {
                questionCount: state.questionCount,
                mode: state.mode,
                autoAnswer: state.autoAnswer,
                isPlaying: state.isPlaying,
                num1: state.num1,
                num2: state.num2,
                ans: state.ans,
                // DOMãªã©ãŒæ··å…¥ã—ã¦ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã‚ˆã†ã€ç´”ç²‹ãªæ–‡å­—åˆ—ã¨ã—ã¦ä¿å­˜
                countsStr: JSON.stringify(state.counts),
                layoutMapStr: JSON.stringify(state.layoutMap),
                carry10Triggered: state.carry10Triggered,
                carry100Triggered: state.carry100Triggered,
                updatedAt: Date.now() 
            };
        }

        // ã€Œæ“ä½œã—ãŸç¬é–“ã€ã«å¿…ãšãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ä¿å­˜ã‚’å®Ÿè¡Œã™ã‚‹
        function saveProgress() { 
            try {
                const cleanData = getCleanStateData();
                localStorage.setItem('math-hissan-saveData', JSON.stringify(cleanData));
            } catch(e) { console.error("Save error:", e); }
        }
        
        // ãƒ–ãƒ©ã‚¦ã‚¶æ›´æ–°æ™‚ï¼ˆé–‰ã˜ã‚‹ç›´å‰ï¼‰ã«ã‚‚æœ€å¾Œã®ã‚ãŒãã§ä¿å­˜ã™ã‚‹
        window.addEventListener('beforeunload', () => {
            saveProgress();
        });

        function loadProgress() { 
            try {
                const savedStr = localStorage.getItem('math-hissan-saveData');
                if (savedStr) { 
                    const data = JSON.parse(savedStr);
                    state.questionCount = data.questionCount || 0; 
                    
                    if (data.mode) {
                        state.mode = data.mode;
                        Array.from(els.modeRadios).forEach(r => r.checked = (r.value === state.mode));
                        if (state.mode === 'coin') {
                            els.coinTable.classList.remove('mode-block');
                            els.coinTable.classList.add('mode-coin');
                        } else {
                            els.coinTable.classList.remove('mode-coin');
                            els.coinTable.classList.add('mode-block');
                        }
                    }
                    
                    if (data.autoAnswer !== undefined) {
                        state.autoAnswer = data.autoAnswer;
                        els.settingAnswer.checked = state.autoAnswer;
                    }

                    updateLevelUI(); 

                    // å‰å›ã®ç”»é¢ãŒã€Œè¨ˆç®—ä¸­ã€ã ã£ãŸå ´åˆã€ç›¤é¢ã¨å•é¡Œã‚’å®Œå…¨ã«å¾©å…ƒ
                    if (data.isPlaying && data.num1 !== undefined) {
                        state.isPlaying = true;
                        state.num1 = data.num1;
                        state.num2 = data.num2;
                        state.ans = data.ans;
                        
                        // æ–‡å­—åˆ—åŒ–ã•ã‚ŒãŸç›¤é¢ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å¾©å…ƒ
                        if (data.countsStr) state.counts = JSON.parse(data.countsStr);
                        if (data.layoutMapStr) state.layoutMap = JSON.parse(data.layoutMapStr);
                        if (data.carry10Triggered !== undefined) state.carry10Triggered = data.carry10Triggered;
                        if (data.carry100Triggered !== undefined) state.carry100Triggered = data.carry100Triggered;
                        
                        els.instruction.style.display = 'none'; 
                        els.workspace.style.display = 'flex'; 
                        els.headerControls.style.display = 'flex'; 
                        els.backToHomeBtn.style.display = 'inline-block';
                        els.startBtn.style.display = 'none'; 
                        els.nextBtn.style.display = 'inline-block'; 
                        
                        els.input1.value = state.num1;
                        els.input2.value = state.num2;
                        els.headerAns.value = "?";
                        els.msg.textContent = "";
                        
                        state.isAnsweredCorrectly = false;
                        
                        // ã‚‚ã—ãƒ‡ãƒ¼ã‚¿ãŒãŠã‹ã—ã‹ã£ãŸã‚‰åˆæœŸåŒ–
                        if (!data.countsStr || Object.keys(state.counts).length === 0) {
                            initVisualCounts(); 
                        }
                        
                        renderVisuals(); 
                        renderHissan();
                    }
                }
            } catch(e) { console.error("Load error:", e); }
        }

        async function fetchAudioBlob(text) {
            try {
                if (!apiKey) throw new Error("No API Key");
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say with extreme enthusiasm and cheerfulness to a child in Japanese: ${text}` }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }
                    })
                });
                if (!response.ok) return null;
                const result = await response.json();
                const base64Data = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!base64Data) return null;
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                return new Blob([bytes.buffer], { type: 'audio/wav' });
            } catch (err) { return null; }
        }
        
        async function unlockAudio() {
            if (state.audioContextStarted) return;
            const audioCtxInternal = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtxInternal.state === 'suspended') await audioCtxInternal.resume();
            state.audioContextStarted = true;
            if (apiKey) {
                for (const text of praises) { if (!state.audioCache[text]) { const blob = await fetchAudioBlob(text); if (blob) state.audioCache[text] = URL.createObjectURL(blob); } }
            }
        }
        
        async function speak(text) {
            if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; }
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
            if (!state.audioContextStarted) await unlockAudio();
            if (state.audioCache[text]) { const audio = new Audio(state.audioCache[text]); currentAudio = audio; audio.play().catch(e => console.error(e)); return; }
            if (apiKey) { try { const blob = await fetchAudioBlob(text); if (blob) { const url = URL.createObjectURL(blob); state.audioCache[text] = url; const audio = new Audio(url); currentAudio = audio; audio.play().catch(e => console.error(e)); return; } } catch(e) { } }
            if ('speechSynthesis' in window) {
                const uttr = new SpeechSynthesisUtterance(text);
                uttr.lang = 'ja-JP';
                const voices = window.speechSynthesis.getVoices();
                const bestVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('ja')) || voices.find(v => v.lang.includes('ja'));
                if (bestVoice) uttr.voice = bestVoice;
                uttr.rate = 1.0; uttr.pitch = 1.2; uttr.volume = 1.0;
                window.speechSynthesis.speak(uttr);
            }
        }

        function resetProgress() { 
            state.questionCount = 0; 
            state.isAnsweredCorrectly = false; 
            updateLevelUI(); 
            generateNextProblem(); 
        }

        function initVisualCounts() {
            const d1 = { 100: Math.floor(state.num1 / 100), 10: Math.floor((state.num1 % 100) / 10), 1: state.num1 % 10 };
            const d2 = { 100: Math.floor(state.num2 / 100), 10: Math.floor((state.num2 % 100) / 10), 1: state.num2 % 10 };
            state.counts = { 'top-100': d1[100], 'top-10': d1[10], 'top-1': d1[1], 'mid-100': d2[100], 'mid-10': d2[10], 'mid-1': d2[1], 'carry-100': 0, 'carry-10': 0, 'carry-1': 0, 'bot-100': 0, 'bot-10': 0, 'bot-1': 0 };
            state.layoutMap = {};
            ['top', 'mid', 'carry'].forEach(row => {
                [100, 10, 1].forEach(val => {
                    const key = `${row}-${val}`; state.layoutMap[key] = []; if (row === 'carry') return;
                    const count = state.counts[key];
                    if (state.mode === 'block' && val === 1) {
                        let rem = count; while(rem >= 5) { state.layoutMap[key].push({val: 5, active: true}); rem -= 5; } while(rem > 0) { state.layoutMap[key].push({val: 1, active: true}); rem--; }
                    } else { for(let i=0; i<count; i++) state.layoutMap[key].push({val: val, active: true}); }
                });
            });
        }

        function renderVisuals() {
            document.querySelectorAll('.coin-zone').forEach(el => Array.from(el.children).forEach(c => { if(!c.classList.contains('zone-label')) c.remove(); }));
            Object.keys(state.layoutMap).forEach(key => {
                const zone = document.getElementById(`zone-${key}`); if (!zone) return;
                const baseVal = parseInt(key.split('-')[1]);
                const container = document.createElement('div');
                if (state.mode === 'block') { if (baseVal === 10) container.className = 'token-container container-ten'; else container.className = 'token-container container-grid'; }
                else { if (baseVal === 10) container.className = 'token-container container-coin-ten'; else container.className = 'token-container container-grid'; }
                state.layoutMap[key].forEach((item, idx) => {
                    const t = createToken(item.val, key, item.active); t.dataset.index = idx; container.appendChild(t);
                });
                zone.appendChild(container);
            });
            ['bot-100', 'bot-10', 'bot-1'].forEach(key => {
                const count = state.counts[key]; if(count === 0) return;
                const val = parseInt(key.split('-')[1]); const zone = document.getElementById(`zone-${key}`);
                const container = document.createElement('div');
                if (state.mode === 'block' && val === 10) container.className = 'token-container container-ten'; 
                else if (state.mode === 'coin' && val === 10) container.className = 'token-container container-coin-ten'; 
                else container.className = 'token-container container-grid';
                if (count >= 10 && val === 1) container.className = 'token-container column-layout';
                if (count >= 10 && val < 100) {
                    const groupBox = document.createElement('div'); groupBox.className = 'ten-group-box';
                    const remainingInputsInColumn = state.counts['top-' + val] + state.counts['mid-' + val];
                    
                    groupBox.onclick = (e) => { 
                        unlockAudio(); 
                        if (remainingInputsInColumn > 0) {
                            speak("ã¾ãšã¯ã€ãœã‚“ã¶ ä¸‹ã« ã†ã”ã‹ã—ã¦ã‹ã‚‰ã€ãƒœã‚¿ãƒ³ã‚’ ãŠãã†ã­ï¼");
                            return;
                        }
                        performRegroup(key, val); 
                    };
                    if (state.mode === 'block') { 
                        if (val === 1) { groupBox.appendChild(createToken(5, key, true, false)); groupBox.appendChild(createToken(5, key, true, false)); } 
                        else { groupBox.appendChild(createToken(100, key, true, false)); } 
                    } else { for(let i=0; i<10; i++) groupBox.appendChild(createToken(val, key, true, false)); }
                    
                    const btn = document.createElement('button'); 
                    btn.className = 'regroup-btn'; 
                    btn.textContent = 'ãã‚Šã‚ã’ã‚‹ï¼';
                    
                    if (remainingInputsInColumn > 0) {
                        btn.style.backgroundColor = '#999';
                        btn.style.boxShadow = 'none';
                        btn.style.animation = 'none';
                        btn.style.cursor = 'not-allowed';
                    }

                    btn.onclick = (e) => { 
                        e.stopPropagation(); 
                        unlockAudio(); 
                        if (remainingInputsInColumn > 0) {
                            speak("ã¾ãšã¯ã€ãœã‚“ã¶ ä¸‹ã« ã†ã”ã‹ã—ã¦ã‹ã‚‰ã€ãƒœã‚¿ãƒ³ã‚’ ãŠãã†ã­ï¼");
                            return;
                        }
                        performRegroup(key, val); 
                    };
                    groupBox.appendChild(btn); container.appendChild(groupBox);
                    let rem = count - 10;
                    if (val === 1 && rem > 0) {
                        const fr = document.createElement('div'); fr.className = 'fraction-container';
                        if (state.mode === 'block') { while(rem >= 5) { fr.appendChild(createToken(5, key, true)); rem -= 5; } while(rem > 0) { fr.appendChild(createToken(1, key, true)); rem--; } } 
                        else { for(let i=0; i<rem; i++) fr.appendChild(createToken(val, key, true)); } container.appendChild(fr);
                    } else if (rem > 0) {
                        for(let i=0; i<rem; i++) container.appendChild(createToken(val, key, true));
                    }
                } else {
                    let rem = count;
                    if (state.mode === 'block' && val === 1) { while(rem >= 5) { container.appendChild(createToken(5, key, true)); rem -= 5; } while(rem > 0) { container.appendChild(createToken(1, key, true)); rem--; } }
                    else { for(let i=0; i<rem; i++) container.appendChild(createToken(val, key, true)); }
                }
                zone.appendChild(container);
            });
        }

        function createToken(val, sourceKey, isActive, isDraggable = true) {
            const el = document.createElement('div'); el.className = `token ${state.mode}-${val} ${state.mode}`;
            if (state.mode === 'coin') el.classList.add(`coin-${val}`);
            if (!isActive) el.classList.add('ghost'); if (state.mode === 'coin') el.textContent = val;
            if (isDraggable) {
                el.addEventListener('mousedown', e => onDragStart(e, el, val, sourceKey)); el.addEventListener('touchstart', e => onDragStart(e, el, val, sourceKey), {passive: false});
            }
            return el;
        }

        function onDragStart(e, el, val, sourceKey) {
            if (el.classList.contains('ghost')) return; 
            
            // é †ç•ªã‚’å³å¯†ã«å®ˆã‚‰ã›ã‚‹ãŸã‚ã®ãƒ‰ãƒ©ãƒƒã‚°åˆ¶é™
            if (val === 10 && sourceKey !== 'carry-100' && sourceKey !== 'bot-100') { 
                if (state.counts['top-1'] > 0 || state.counts['mid-1'] > 0) { 
                    speak("ã¾ãšã¯ã€ã„ã¡ã® ãã‚‰ã„ã‹ã‚‰ã€ã†ã”ã‹ãã†ã­ï¼"); e.preventDefault(); return; 
                }
                if (state.counts['bot-1'] >= 10) {
                    speak("ã„ã¡ã® ãã‚‰ã„ã‚’ ãã‚Šã‚ã’ã¦ã‹ã‚‰ã€ã˜ã‚…ã†ã® ãã‚‰ã„ã‚’ ã†ã”ã‹ãã†ã­ï¼"); e.preventDefault(); return;
                }
            }
            if (val === 100) { 
                if (state.counts['top-1'] > 0 || state.counts['mid-1'] > 0 || state.counts['top-10'] > 0 || state.counts['mid-10'] > 0) { 
                    speak("ã¾ãšã¯ã€ã¡ã„ã•ã„ ãã‚‰ã„ã‹ã‚‰ã€ã˜ã‚…ã‚“ã°ã‚“ã« ã†ã”ã‹ãã†ã­ï¼"); e.preventDefault(); return; 
                }
                if (state.counts['bot-1'] >= 10 || state.counts['bot-10'] >= 10) {
                    speak("ãã‚Šã‚ã’ã‚’ ãŠã‚ã‚‰ã›ã¦ã‹ã‚‰ã€ã²ã‚ƒãã® ãã‚‰ã„ã‚’ ã†ã”ã‹ãã†ã­ï¼"); e.preventDefault(); return;
                }
            }
            
            e.preventDefault(); unlockAudio();
            const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY;
            const rect = el.getBoundingClientRect(); const proxy = el.cloneNode(true);
            proxy.style.position = 'fixed'; proxy.style.left = rect.left + 'px'; proxy.style.top = rect.top + 'px';
            proxy.style.width = rect.width + 'px'; proxy.style.height = rect.height + 'px';
            proxy.style.zIndex = 2000; proxy.style.pointerEvents = 'none'; proxy.style.opacity = '1.0';
            document.body.appendChild(proxy); el.classList.add('ghost');
            state.dragging = { el, proxy, val, sourceKey, index: el.dataset.index, offsetX: cx - rect.left, offsetY: cy - rect.top };
        }
        function onDragMove(e) { if (!state.dragging) return; e.preventDefault(); const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY; state.dragging.proxy.style.left = (cx - state.dragging.offsetX) + 'px'; state.dragging.proxy.style.top = (cy - state.dragging.offsetY) + 'px'; }
        
        function onDragEnd(e) {
            if (!state.dragging) return; const { el, proxy, val, sourceKey, index } = state.dragging;
            const cx = e.changedTouches ? e.changedTouches[0].clientX : e.clientX; const cy = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            proxy.remove(); const target = document.elementFromPoint(cx, cy)?.closest('.coin-zone');
            
            // ãƒ‰ãƒ­ãƒƒãƒ—å…ˆãŒæ­£ã—ã„ä½ï¼ˆ1ã®ä½ã€10ã®ä½ãªã©ï¼‰ã§ã‚ã‚‹ã‹å³å¯†ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹
            const sourceBaseVal = parseInt(sourceKey.split('-')[1]);
            const targetBaseVal = target ? parseInt(target.dataset.val) : null;
            const isMatch = (targetBaseVal === sourceBaseVal) && ((val === sourceBaseVal) || (sourceBaseVal === 1 && (val === 1 || val === 5)));
            
            if (target && target.dataset.row === 'bot' && isMatch) {
                if (state.layoutMap[sourceKey] && index !== undefined) state.layoutMap[sourceKey][index].active = false;
                const unitDelta = val / sourceBaseVal; state.counts[sourceKey] -= unitDelta; state.counts[`bot-${sourceBaseVal}`] += unitDelta; 
                renderVisuals(); 
                syncHissanWithVisuals();
                saveProgress(); // æ“ä½œã®ãŸã³ã«å³åº§ã«ä¿å­˜
            } else { el.classList.remove('ghost'); }
            state.dragging = null;
        }

        function performRegroup(sourceKey, val) { 
            state.counts[sourceKey] -= 10; 
            state.counts[`carry-${val*10}`]++; 
            state.layoutMap[`carry-${val*10}`].push({val: val*10, active: true}); 
            if (val === 1) state.carry10Triggered = true;
            if (val === 10) state.carry100Triggered = true;
            renderVisuals(); 
            syncHissanWithVisuals(); 
            saveProgress(); // æ“ä½œã®ãŸã³ã«å³åº§ã«ä¿å­˜
        }
        
        function syncHissanWithVisuals() {
            if (!els.settingAnswer.checked) return; 
            
            const b1 = state.counts['bot-1'];
            const b10 = state.counts['bot-10'];
            const b100 = state.counts['bot-100'];
            const vc10 = state.counts['carry-10'];
            const vc100 = state.counts['carry-100'];

            if (b1 === 0 && b10 === 0 && b100 === 0 && vc10 === 0 && vc100 === 0 && !state.carry10Triggered && !state.carry100Triggered) {
                if (document.getElementById('ans-1')) document.getElementById('ans-1').value = "";
                if (document.getElementById('ans-10')) document.getElementById('ans-10').value = "";
                if (document.getElementById('ans-100')) document.getElementById('ans-100').value = "";
                els.carry10.value = ""; els.carry100.value = ""; return;
            }

            els.carry10.value = state.carry10Triggered ? "1" : "";
            els.carry100.value = state.carry100Triggered ? "1" : "";

            if (document.getElementById('ans-1')) {
                document.getElementById('ans-1').value = state.carry10Triggered ? (b1 % 10) : b1;
            }
            
            if (document.getElementById('ans-10')) {
                const currentTens = b10; 
                const val10 = state.carry100Triggered ? (currentTens % 10) : currentTens;
                if (currentTens > 0 || b100 > 0 || state.carry100Triggered) {
                    document.getElementById('ans-10').value = val10;
                } else {
                    document.getElementById('ans-10').value = "";
                }
            }
            
            if (document.getElementById('ans-100')) {
                const currentHundreds = b100;
                document.getElementById('ans-100').value = currentHundreds === 0 ? "" : currentHundreds;
            }
        }

        function renderHissan() {
            els.hissanGrid.innerHTML = "";
            const d1 = { 100: Math.floor(state.num1 / 100), 10: Math.floor((state.num1 % 100) / 10), 1: state.num1 % 10 };
            const d2 = { 100: Math.floor(state.num2 / 100), 10: Math.floor((state.num2 % 100) / 10), 1: state.num2 % 10 };
            const vals = [d1[100], d1[10], d1[1], d2[100]||'', d2[10], d2[1]];
            vals.forEach((v, idx) => {
                const cell = document.createElement('div'); cell.className = 'hissan-cell';
                if (idx === 3 && v === '') { const op = document.createElement('span'); op.className = 'operator'; op.textContent = 'ï¼‹'; cell.appendChild(op); }
                else { cell.textContent = v === 0 ? '' : v; } els.hissanGrid.appendChild(cell);
            });
            ['ans-100', 'ans-10', 'ans-1'].forEach(id => {
                const cell = document.createElement('div'); cell.className = 'hissan-cell';
                const inp = document.createElement('input'); inp.id = id; inp.className = 'hissan-input'; inp.inputMode = 'numeric';
                inp.oninput = (e) => e.target.value = e.target.value.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/[^0-9]/g, '');
                cell.appendChild(inp); els.hissanGrid.appendChild(cell);
            });
            els.carry10.value = ""; els.carry100.value = ""; if (els.settingAnswer.checked) syncHissanWithVisuals();
        }

        function generateNextProblem() {
            state.isAnsweredCorrectly = false; 
            state.carry10Triggered = false;
            state.carry100Triggered = false;
            let n1, n2; const count = state.questionCount + 1;
            const getUnitWithCarry = () => { const u1 = Math.floor(Math.random() * 9) + 1; const minU2 = 10 - u1; const u2 = Math.floor(Math.random() * (9 - minU2 + 1)) + minU2; return { u1, u2 }; };
            
            // ãƒ¬ãƒ™ãƒ«ã”ã¨ã®å•é¡Œè¨­å®šã®å³æ ¼åŒ–
            if (count <= 5) { // ãƒ¬ãƒ™ãƒ«1
                const { u1, u2 } = getUnitWithCarry(); 
                n1 = (Math.floor(Math.random() * 5) + 1) * 10 + u1; 
                n2 = u2; 
            } 
            else if (count <= 10) { // ãƒ¬ãƒ™ãƒ«2 (çµ¶å¯¾ã«100ã«ã¯è¡Œã‹ãªã„ã‚ˆã†ã«æœ€å¤§80ã¾ã§ã«åˆ¶é™)
                const { u1, u2 } = getUnitWithCarry(); 
                n1 = (Math.floor(Math.random() * 8) + 1) * 10 + u1; 
                n2 = u2; 
            } 
            else if (count <= 20) { // ãƒ¬ãƒ™ãƒ«3, 4
                const { u1, u2 } = getUnitWithCarry(); 
                const t1 = Math.floor(Math.random() * 7) + 1; 
                const maxT2 = 8 - t1; 
                const t2 = Math.floor(Math.random() * maxT2) + 1; 
                n1 = t1 * 10 + u1; 
                n2 = t2 * 10 + u2; 
            } 
            else { // ãƒ¬ãƒ™ãƒ«5, 6
                const { u1, u2 } = getUnitWithCarry(); 
                const t1 = Math.floor(Math.random() * 9) + 1; 
                const minT2 = 9 - t1; 
                const t2 = Math.floor(Math.random() * (9 - minT2 + 1)) + minT2; 
                n1 = t1 * 10 + u1; 
                n2 = t2 * 10 + u2; 
            }
            state.num1 = n1; state.num2 = n2; state.ans = n1 + n2; 
            
            els.input1.value = n1; els.input2.value = n2; 
            initVisualCounts(); 
            
            saveProgress(); // æ–°å•é¡Œã®åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜
            
            renderVisuals(); 
            renderHissan(); 
            els.headerAns.value = "?"; els.msg.textContent = "";
        }
        
        function checkAnswer() {
            if (state.isAnsweredCorrectly) { if (Date.now() - state.lastGuideTime < 3000) return; state.lastGuideTime = Date.now(); speak(praises[10]); return; }
            const u100 = parseInt(document.getElementById('ans-100')?.value) || 0; const u10 = parseInt(document.getElementById('ans-10')?.value) || 0; const u1 = parseInt(document.getElementById('ans-1')?.value) || 0;
            if (u100 * 100 + u10 * 10 + u1 === state.ans) {
                state.isAnsweredCorrectly = true;
                state.questionCount++; 
                saveProgress(); 
                updateLevelUI(); 
                
                if (state.questionCount === 30) speak(praises[8]);
                else if (state.questionCount % 5 === 0) speak(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ã—ã‚‡ã†ã”ã†ãŒã€${state.titles[Math.min(Math.floor(state.questionCount / 5), state.titles.length - 1)]}ã«ãªã£ãŸã‚ˆï¼ãŠã‚ã§ã¨ãƒ¼ãƒ¼ãƒ¼ï¼`);
                else { 
                    let pIdx; do { pIdx = Math.floor(Math.random() * 8); } while (pIdx === state.lastPraiseIndex);
                    state.lastPraiseIndex = pIdx; speak(praises[pIdx]);
                }
                els.bigText.classList.add('show'); setTimeout(() => els.bigText.classList.remove('show'), 2000);
                for(let i=0; i<100; i++){ const p = document.createElement('div'); p.className='confetti-piece'; p.style.left = Math.random() * 100 + 'vw'; p.style.backgroundColor = ['#f44336','#e91e63','#9c27b0','#673ab7','#3f51b5','#2196f3','#03a9f4','#00bcd4','#009688','#4caf50','#8bc34a','#cddc39','#ffeb3b','#ffc107','#ff9800','#ff5722'][Math.floor(Math.random()*16)]; p.style.animationDuration = (Math.random() * 3 + 2) + 's'; p.style.animationDelay = (Math.random() * 2) + 's'; document.body.appendChild(p); setTimeout(()=>p.remove(), 5000); }
                els.headerAns.value = state.ans; if (state.questionCount === 30) setTimeout(() => els.masterModal.style.display = 'flex', 500);
            } else { speak(praises[9]); }
        }

        // --- ç¢ºå®ŸãªåˆæœŸåŒ–ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ç‰ˆï¼‰ ---
        const initApp = () => {
            const hideLoading = () => {
                if (els.loadingOverlay.style.display !== 'none') {
                    els.loadingOverlay.style.opacity = '0';
                    setTimeout(() => els.loadingOverlay.style.display = 'none', 300);
                }
            };

            try {
                if(els.userIdFooter) {
                    els.userIdFooter.textContent = 'ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ¢ãƒ¼ãƒ‰';
                }
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                loadProgress(); 
            } catch(e) { 
                console.error("Init error:", e); 
            } finally {
                hideLoading();
            }
        };
        
        // ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ã«å®Ÿè¡Œ
        initApp();
        
        els.startBtn.addEventListener('click', async () => { 
            try {
                await unlockAudio(); 
                state.isPlaying = true;
                els.workspace.style.display = 'flex'; 
                els.instruction.style.display = 'none'; 
                els.headerControls.style.display = 'flex'; 
                els.backToHomeBtn.style.display = 'inline-block';
                els.startBtn.style.display = 'none'; 
                els.nextBtn.style.display = 'inline-block'; 
                generateNextProblem(); 
            } catch (e) { console.error(e); }
        });

        els.nextBtn.addEventListener('click', () => { unlockAudio(); generateNextProblem(); });
        els.checkBtn.addEventListener('click', () => { unlockAudio(); checkAnswer(); });
        els.modalClose.addEventListener('click', () => { els.masterModal.style.display = 'none'; generateNextProblem(); });
        
        // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
        els.resetBtn.addEventListener('click', () => {
            if (confirm("ã»ã‚“ã¨ã†ã« æœ€åˆã‹ã‚‰ ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã‚Œã¾ã§ã®è¨˜éŒ²ãŒ 0 ã«ãªã‚Šã¾ã™ï¼‰")) {
                resetProgress();
            }
        });
        
        els.backToHomeBtn.addEventListener('click', () => { 
            state.isPlaying = false;
            saveProgress();
            els.workspace.style.display = 'none'; 
            els.headerControls.style.display = 'none'; 
            els.instruction.style.display = 'flex'; 
            els.backToHomeBtn.style.display = 'none';
            els.startBtn.style.display = 'block'; 
        });

        Array.from(els.modeRadios).forEach(radio => {
            radio.addEventListener('change', e => {
                state.mode = e.target.value;
                if (state.mode === 'coin') {
                    els.coinTable.classList.remove('mode-block');
                    els.coinTable.classList.add('mode-coin');
                } else {
                    els.coinTable.classList.remove('mode-coin');
                    els.coinTable.classList.add('mode-block');
                }
                saveProgress();
                initVisualCounts();
                renderVisuals();
            });
        });

        els.settingAnswer.addEventListener('change', e => {
            state.autoAnswer = e.target.checked;
            saveProgress();
            syncHissanWithVisuals();
        });

        document.addEventListener('mousemove', onDragMove); document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchmove', onDragMove, {passive:false}); document.addEventListener('touchend', onDragEnd);
    </script>
</body>
</html>
